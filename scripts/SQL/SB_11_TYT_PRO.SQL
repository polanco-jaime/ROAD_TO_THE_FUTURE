CREATE OR REPLACE TABLE `ph-jabri.ICFES.SB11_SBPRO_SBTYT`
OPTIONS () AS  
WITH SB11_PRO
AS (
SELECT 
CASE 
WHEN estu_consecutivo_sb11 IS NULL AND CAST(ANIO AS NUMERIC) BETWEEN 2011 AND 2018  THEN 0 
WHEN estu_consecutivo_sb11 IS NOT NULL AND CAST(ANIO AS NUMERIC) BETWEEN 2011 AND 2018  THEN 1 
ELSE NULL END SB_PRO
, B.estu_consecutivo_sbpro , A.*, CAST(ANIO AS NUMERIC) AS ANIO_SB11 FROM 
                    (SELECT * 
                      FROM `ph-jabri.ICFES.SABER_11_2006_2023` 
                      WHERE CAST(ANIO AS NUMERIC) BETWEEN 2006 AND 2023  )  A
LEFT JOIN `ph-jabri.SABER_PRO.Saber11_SaberPro_20232` B
-- ON ESTU_CONSECUTIVO = estu_consecutivo_sb11
ON REPLACE( REPLACE(ESTU_CONSECUTIVO, 'SB11', ''), 'SABER11', '')  =
REPLACE( REPLACE(estu_consecutivo_sb11, 'SB11', ''), 'SABER11', '') 
 ),
 SB11_PRO_TYT AS (
 SELECT 
 CASE WHEN B.estu_consecutivo_sb11 IS NOT NULL AND CAST(ANIO AS NUMERIC)>=2015  THEN 1 
 WHEN B.estu_consecutivo_sb11 IS  NULL AND CAST(ANIO AS NUMERIC)>=2015  THEN 0 
 ELSE NULL END SB_TYT,
 B.estu_consecutivo_sbtyt, 
 A.* FROM SB11_PRO A
 LEFT JOIN `ph-jabri.SABER_TyT.Saber11_SaberTyT_20232` B
  ON ESTU_CONSECUTIVO = estu_consecutivo_sb11  
),
TYT AS (
  SELECT
ESTU_GENERO		AS	ESTU_GENERO_SBTYT,
ESTU_FECHANACIMIENTO		AS	ESTU_FECHANACIMIENTO_SBTYT,
PERIODO		AS	PERIODO_SBTYT,
ESTU_CONSECUTIVO		AS	ESTU_CONSECUTIVO_SB_TYT,
ESTU_CODDANE_COLE_TERMINO		AS	ESTU_CODDANE_COLE_TERMINO_SBTYT,
ESTU_COD_COLE_MCPIO_TERMINO		AS	ESTU_COD_COLE_MCPIO_TERMINO_SBTYT,
ESTU_SEMESTRECURSA		AS	ESTU_SEMESTRECURSA_SBTYT,
FAMI_ESTRATOVIVIENDA		AS	FAMI_ESTRATOVIVIENDA_SBTYT,
FAMI_NIVEL_SISBEN		AS	FAMI_NIVEL_SISBEN_SBTYT,
FAMI_INGRESO_FMILIAR_MENSUAL		AS	FAMI_INGRESO_FMILIAR_MENSUAL_SBTYT,
ESTU_TRABAJA_ACTUALMENTE		AS	ESTU_TRABAJA_ACTUALMENTE_SBTYT,
ESTU_HORASSEMANATRABAJA		AS	ESTU_HORASSEMANATRABAJA_SBTYT,
ESTU_PRGM_ACADEMICO		AS	ESTU_PRGM_ACADEMICO_SBTYT,
GRUPOREFERENCIA		AS	GRUPOREFERENCIA_SBTYT,
ESTU_PRGM_CODMUNICIPIO		AS	ESTU_PRGM_CODMUNICIPIO_SBTYT,
ESTU_NUCLEO_PREGRADO		AS	ESTU_NUCLEO_PREGRADO_SBTYT,
PUNT_GLOBAL		AS	PUNT_GLOBAL_SBTYT,
ESTU_INSE_INDIVIDUAL		AS	ESTU_INSE_INDIVIDUAL_SBTYT,
ESTU_NSE_INDIVIDUAL		AS	ESTU_NSE_INDIVIDUAL_SBTYT,

  FROM `ph-jabri.ICFES.SBTyT_PANEL`  
), 
FULL_SB11_TYT AS (
SELECT *, 
ROW_NUMBER() OVER (PARTITION BY ESTU_CONSECUTIVO) AS RN_TYT
FROM SB11_PRO_TYT
LEFT JOIN TYT
ON ESTU_CONSECUTIVO_SB_TYT =ESTU_CONSECUTIVO_SBTYT
),
FULL_SB11_PRO AS (
  SELECT
          ESTU_GENERO		AS	ESTU_GENERO_SBPRO,
          ESTU_FECHANACIMIENTO		AS	ESTU_FECHANACIMIENTO_SBPRO,
          PERIODO		AS	PERIODO_SBPRO,
          ESTU_CONSECUTIVO		AS	ESTU_CONSECUTIVO_SB_PRO,
          ESTU_CODDANE_COLE_TERMINO		AS	ESTU_CODDANE_COLE_TERMINO_SBPRO,
          ESTU_COD_COLE_MCPIO_TERMINO		AS	ESTU_COD_COLE_MCPIO_TERMINO_SBPRO,
          ESTU_SEMESTRECURSA		AS	ESTU_SEMESTRECURSA_SBPRO,
          FAMI_ESTRATOVIVIENDA		AS	FAMI_ESTRATOVIVIENDA_SBPRO,
          ESTU_HORASSEMANATRABAJA		AS	ESTU_HORASSEMANATRABAJA_SBPRO,
          ESTU_PRGM_ACADEMICO		AS	ESTU_PRGM_ACADEMICO_SBPRO,
          GRUPOREFERENCIA		AS	GRUPOREFERENCIA_SBPRO,
          ESTU_PRGM_CODMUNICIPIO		AS	ESTU_PRGM_CODMUNICIPIO_SBPRO,
          ESTU_NUCLEO_PREGRADO		AS	ESTU_NUCLEO_PREGRADO_SBPRO,
          PUNT_GLOBAL		AS	PUNT_GLOBAL_SBPRO,
          ESTU_INSE_INDIVIDUAL		AS	ESTU_INSE_INDIVIDUAL_SBPRO,
          ESTU_NSE_INDIVIDUAL		AS	ESTU_NSE_INDIVIDUAL_SBPRO,
          STEM_LEVEL_1		AS	STEM_LEVEL_1_SBPRO,
          STEM_LEVEL_2		AS	STEM_LEVEL_2_SBPRO,
  FROM `ph-jabri.SABER_PRO.UNCLEAN_SBPRO_2006_2022`  
)
SELECT *,
 
    CASE
    WHEN ESTU_NUCLEO_PREGRADO_SBTYT IN (
      'INGENIERÍA AMBIENTAL, SANITARIA Y AFINES',
      'INGENIERÍA CIVIL Y AFINES',
      'INGENIERÍA ELÉCTRICA Y AFINES',
      'INGENIERÍA ELECTRÓNICA, TELECOMUNICACIONES Y AFINES',
      'INGENIERÍA INDUSTRIAL Y AFINES',
      'INGENIERÍA MECÁNICA Y AFINES',
      'INGENIERÍA QUÍMICA Y AFINES',
      'GEOLOGÍA, OTROS PROGRAMAS DE CIENCIAS NATURALES',
      'INGENIERÍA DE MINAS, METALURGIA Y AFINES'
    ) THEN 1
    WHEN ESTU_NUCLEO_PREGRADO_SBTYT LIKE '%PETROL%' THEN 1
    ELSE 0
  END AS DUM_NUCLEO_PETROLEOS_TYT, 
      CASE WHEN ESTU_PRGM_ACADEMICO_SBTYT IN (
      'TÉCNICA PROFESIONAL EN OPERACIONES MINERAS',
      'TECNOLOGÍA EN OPERACIÓN Y MANTENIMIENTO ELECTROMECÁNICO',
      'TECNOLOGÍA EN ESTUDIOS GEOTÉCNICOS',
      'TECNOLOGÍA EN SUPERVISIÓN DE PROCESOS MINEROS',
      'TECNOLOGÍA EN INSTALACIONES HIDRÁULICAS SANITARIAS Y DE GAS',
      'TECNOLOGÍA EN GESTIÓN PARA EL SUMINISTRO GASES COMBUSTIBLES Y NO COMBUSTIBLES',
      'TECNOLOGÍA EN MANEJO DE PETRÓLEO Y GAS EN SUPERFICIE',
      'TECNOLOGÍA EN OPERACIÓN DE PLANTAS PETROQUÍMICAS',
      'TECNOLOGÍA EN PRODUCCIÓN DE PETRÓLEO',
      'TÉCNICO PROFESIONAL EN PERFORACIÓN DE POZOS PETROLÍFEROS',
      'TECNOLOGÍA EN SUPERVISIÓN DE LABORES MINERAS',
      'TECNOLOGÍA EN INSTRUMENTACIÓN INDUSTRIAL',
      'TECNOLOGÍA EN CONTROL DE PROCESOS ELECTRÓNICOS',
      'TECNOLOGÍA EN QUÍMICA APLICADA A LA INDUSTRIA',
      'TECNOLOGÍA EN GESTIÓN INTEGRADA DE LA CALIDAD, MEDIO AMBIENTE, SEGURIDAD Y SALUD OCUPACIONAL',
      'TECNOLOGÍA EN PRODUCCIÓN INDUSTRIAL',
      'TECNOLOGÍA EN MANTENIMIENTO MECÁNICO INDUSTRIAL',
      'TECNOLOGÍA EN GESTIÓN DE PROCESOS INDUSTRIALES'
    ) THEN 1
   WHEN ESTU_PRGM_ACADEMICO_SBTYT LIKE '%PETROL%' THEN 1
    ELSE 0
  END AS DUM_PRGM_PETROLEOS_TYT,
  CASE
    WHEN ESTU_PRGM_ACADEMICO_SBTYT IN (
      'TECNOLOGÍA EN GESTIÓN DE RECURSOS NATURALES',
      'TECNOLOGÍA EN BIOCOMERCIO SOSTENIBLE',
      'TECNOLOGÍA EN AGROFORESTERIA',
      'TECNOLOGÍA EN GESTIÓN AMBIENTAL',
      'TECNICO PROFESIONAL EN MANEJO Y CONSERVACIÓN DE PRODUCTOS AGROINDUSTRIALES',
      'TECNOLOGÍA EN PRODUCCIÓN FORESTAL',
      'TECNOLOGÍA EN GESTIÓN AGROINDUSTRIAL',
      'TECNICA PROFESIONAL EN MONITOREO AMBIENTAL',
      'TECNICO PROFESIONAL EN PROCESOS AMBIENTALES',
      'TECNOLOGÍA EN SANEAMIENTO AMBIENTAL',
      'TECNOLOGÍA EN MANEJO DE RECURSOS AMBIENTALES',
      'TECNICO PROFESIONAL EN GESTIÓN AMBIENTAL',
      'TECNOLOGÍA EN PRODUCCIÓN AGROPECUARIA ECOLÓGICA',
      'TECNOLOGÍA EN GESTIÓN AMBIENTAL TERRITORIAL',
      'TECNOLOGIA EN GESTION AGROAMBIENTAL',
      'TECNOLOGÍA EN GESTIÓN AGROFORESTAL',
      'TECNOLOGÍA EN GESTIÓN DE RECURSOS NATURALES',
      'TECNOLOGÍA EN CONTROL AMBIENTAL',
      'TECNICO PROFESIONAL EN PROCESOS DE AGRICULTURA ORGANICA',
      'TECNICA PROFESIONAL EN PROCESOS AMBIENTALES'
    ) THEN 1
    ELSE 0
  END AS DUM_PRGM_AMBIENTE_TYT, 
  
  CASE
    WHEN ESTU_PRGM_ACADEMICO_SBPRO IN (
      'GEOLOGIA',
    --   'INGENIERIA AMBIENTAL',
    --   'INGENIERIA CIVIL',
      'INGENIERIA MECÁNICA',
      'INGENIERIA GEOLOGICA',
      'INGENIERÍA EN ENERGÍA',
      'INGENIERÍA DE PETRÓLEO Y GAS',
      'INGENIERÍA DE PETRÓLEOS',
      'INGENIERÍA QUÍMICA',
      'INGENIERÍA DE MINAS Y METALURGIA',
      'INGENIERIA DE MINAS'
    ) THEN 1
     WHEN ESTU_PRGM_ACADEMICO_SBPRO LIKE '%PETROL%' THEN 1
    ELSE 0
  END AS DUM_PRGM_PETROLEOS_SBPRO,

CASE
    WHEN ESTU_NUCLEO_PREGRADO_SBPRO IN (
      'GEOLOGIA',
    --   'INGENIERIA AMBIENTAL Y SANITARIA',
    --   'INGENIERÍA AMBIENTAL',
    --   'INGENIERÍA CIVIL',
      'INGENIERIA GEOLOGICA',
      'INGENIERÍA EN ENERGÍA',
      'INGENIERÍA DE PETRÓLEO Y GAS',
      'INGENIERÍA DE PETRÓLEOS',
      'INGENIERÍA QUÍMICA',
      'INGENIERÍA DE MINAS Y METALURGIA',
      'INGENIERIA DE MINAS',
      'INGENIERÍA EN ENERGÍAS',
      'INGENIERÍA GEOLÓGICA',
      'INGENIERÍA PETROQUÍMICA'
    ) THEN 1
    WHEN ESTU_NUCLEO_PREGRADO_SBPRO LIKE '%PETROL%' THEN 1
    ELSE 0
  END AS DUM_NUCLEO_PETROLEOS_SBPRO, 
    CASE
    WHEN ESTU_PRGM_ACADEMICO_SBPRO IN (
       'CIENCIAS AMBIENTALES',
      'INGENIERÍA GEOLÓGICA',
      'LICENCIATURA EN CIENCIAS NATURALES Y EDUCACIÓN AMBIENTAL',
      'LICENCIATURA EN EDUCACION BASICA CON ENFASIS EN CIENCIAS NATURALES Y EDUCACIÓN AMBIENTAL',
      'MICROBIOLOGIA INDUSTRIAL Y AMBIENTAL',
      'INGENIERIA GEOGRAFICA Y AMBIENTAL',
      'LICENCIATURA EN EDUCACION AMBIENTAL',
      'INGENIERÍA AMBIENTAL Y SANITARIA',
      'GESTIÓN EN ECOLOGÍA Y TURISMO',
      'ADMINISTRACION DEL TURISMO SOSTENIBLE',
      'ADMINISTRACIÓN AMBIENTAL Y DE LOS RECURSOS NATURALES',
      'LICENCIATURA EN QUIMICA Y EDUCACION AMBIENTAL',
      'QUIMICA AMBIENTAL',
      'ECOLOGIA DE ZONAS COSTERAS',
      'INGENIERIA AMBIENTAL',
      'LICENCIATURA EN BIOLOGIA CON ENFASIS EN EDUCACION AMBIENTAL',
      'BIOLOGIA AMBIENTAL',
      'ECOLOGÍA',
      'ADMINISTRACION Y GESTION AMBIENTAL',
      'INGENIERIA AGROECOLOGICA',
      'INGENIERÍA AGROECOLÓGICA',
      'INGENIERÍA FORESTAL',
      'GEOGRAFIA DEL DESARROLLO REGIONAL Y AMBIENTAL',
      'LICENCIATURA EN BIOLOGIA Y EDUCACION AMBIENTAL'
    ) THEN 1
    WHEN ESTU_PRGM_ACADEMICO_SBPRO LIKE '%AGROF%' THEN 1
    ELSE 0
  END AS DUM_PRGM_AMBIENTE_SBPRO


 FROM FULL_SB11_TYT 
LEFT JOIN FULL_SB11_PRO
 ON estu_consecutivo_sbpro = ESTU_CONSECUTIVO_SB_PRO
 